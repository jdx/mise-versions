---
import Layout from '../../layouts/Layout.astro';
import { drizzle } from 'drizzle-orm/d1';
import { setupAnalytics } from '../../../../src/analytics';
import * as smolToml from 'smol-toml';

const { tool } = Astro.params;

if (!tool) {
  return Astro.redirect('/');
}

// Fetch tools.json directly from GitHub Pages (avoid subrequest to same Worker)
const toolsRes = await fetch('https://mise-versions.jdx.dev/tools.json');
const toolsData = await toolsRes.json() as {
  tools: Array<{
    name: string;
    latest_version: string;
    version_count: number;
    last_updated: string | null;
    description?: string;
    backends?: string[];
    homepage?: string;
    repo_url?: string;
    license?: string;
    github?: string;
  }>;
};

const toolMeta = toolsData.tools.find(t => t.name === tool);

if (!toolMeta) {
  return Astro.redirect('/');
}

// Fetch versions from TOML file directly from GitHub Pages
let versions: Array<{ version: string; created_at?: string | null }> = [];
try {
  const tomlRes = await fetch(`https://mise-versions.jdx.dev/${tool}.toml`);
  if (tomlRes.ok) {
    const tomlText = await tomlRes.text();
    const parsed = smolToml.parse(tomlText) as { versions?: Array<{ version: string; created_at?: string }> };
    versions = parsed.versions || [];
  }
} catch (e) {
  console.error('Failed to fetch versions TOML:', e);
}

// Fetch download stats
let downloadStats: {
  total: number;
  daily: Array<{ date: string; count: number }>;
  monthly: Array<{ month: string; count: number }>;
  byVersion: Array<{ version: string; count: number }>;
} = { total: 0, daily: [], monthly: [], byVersion: [] };

try {
  const runtime = Astro.locals.runtime;
  const db = drizzle(runtime.env.ANALYTICS_DB);
  const analytics = setupAnalytics(db);
  downloadStats = await analytics.getDownloadStats(tool);
} catch (e) {
  console.error('Failed to fetch download stats:', e);
}

// Calculate 30-day downloads
const thirtyDayDownloads = downloadStats.daily.reduce((sum, d) => sum + d.count, 0);

// Prepare chart data (30 days filled)
const chartData: { date: string; count: number; height: number; label: string }[] = [];
const maxCount = Math.max(...downloadStats.daily.map(d => d.count), 1);
const today = new Date();
const dailyMap = new Map(downloadStats.daily.map(d => [d.date, d.count]));

for (let i = 29; i >= 0; i--) {
  const date = new Date(today);
  date.setDate(date.getDate() - i);
  const dateStr = date.toISOString().split('T')[0];
  const count = dailyMap.get(dateStr) || 0;
  const height = maxCount > 0 ? (count / maxCount) * 100 : 0;
  const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  chartData.push({ date: dateStr, count, height, label });
}

// Format numbers
function formatNumber(n: number): string {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
  return n.toString();
}

// Get page title and description
const pageTitle = tool;
const pageDescription = toolMeta.description || `${tool} - version manager tool`;

// Backend URLs
function backendToUrl(backend: string): string | null {
  const match = backend.match(/^(?<prefix>.+?):(?<slug>.+?)(?:\[.+\])?$/);
  if (!match?.groups) return null;
  const { prefix, slug } = match.groups;
  switch (prefix) {
    case 'npm': return `https://www.npmjs.com/package/${slug}`;
    case 'cargo': return `https://crates.io/crates/${slug}`;
    case 'pipx': return `https://pypi.org/project/${slug}`;
    case 'gem': return `https://rubygems.org/gems/${slug}`;
    case 'go': return `https://pkg.go.dev/${slug}`;
    case 'aqua':
    case 'github':
    case 'ubi':
    case 'asdf':
    case 'vfox':
      return `https://github.com/${slug.split('/').slice(0, 2).join('/')}`;
    case 'core': return `https://mise.jdx.dev/lang/${slug}.html`;
    default: return null;
  }
}
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex items-start justify-between">
      <div>
        <a href="/" class="text-sm text-gray-400 hover:text-neon-purple transition-colors mb-2 inline-block">
          &larr; Back to tools
        </a>
        <h1 class="text-3xl font-bold text-gray-100">{tool}</h1>
        {toolMeta.description && (
          <p class="text-gray-400 mt-2">{toolMeta.description}</p>
        )}
      </div>
      <div class="text-right">
        <div class="text-3xl font-bold text-neon-purple">{formatNumber(thirtyDayDownloads)}</div>
        <div class="text-sm text-gray-400">downloads (30d)</div>
      </div>
    </div>

    <!-- Install Command -->
    <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
      <h2 class="text-sm font-medium text-gray-400 mb-2">Install</h2>
      <div class="bg-dark-900 rounded px-4 py-3 font-mono text-sm text-gray-200 flex items-center justify-between">
        <code>mise use -g {tool}@latest</code>
        <button
          id="copyBtn"
          class="text-gray-400 hover:text-neon-purple transition-colors"
          title="Copy to clipboard"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
        <div class="text-sm text-gray-400">Latest</div>
        <div class="text-xl font-mono text-gray-200">{toolMeta.latest_version}</div>
      </div>
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
        <div class="text-sm text-gray-400">Versions</div>
        <div class="text-xl text-gray-200">{toolMeta.version_count}</div>
      </div>
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
        <div class="text-sm text-gray-400">Total Downloads</div>
        <div class="text-xl text-gray-200">{formatNumber(downloadStats.total)}</div>
      </div>
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
        <div class="text-sm text-gray-400">Last Updated</div>
        <div class="text-xl text-gray-200">
          {toolMeta.last_updated
            ? new Date(toolMeta.last_updated).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
            : '-'}
        </div>
      </div>
    </div>

    <!-- Downloads Chart -->
    <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
      <h2 class="text-lg font-semibold text-gray-200 mb-4">Downloads (30 days)</h2>
      {chartData.length > 0 ? (
        <div class="h-32 flex items-end gap-0.5">
          {chartData.map(d => (
            <div class="flex-1 h-full flex items-end group relative" title={`${d.label}: ${d.count} downloads`}>
              <div
                class="w-full bg-neon-purple hover:bg-neon-pink transition-colors rounded-t"
                style={`height: ${Math.max(d.height, 2)}%`}
              />
            </div>
          ))}
        </div>
      ) : (
        <div class="text-gray-500 text-sm py-4">No download data yet</div>
      )}
    </div>

    <!-- Links & Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Backends -->
      {toolMeta.backends && toolMeta.backends.length > 0 && (
        <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
          <h2 class="text-sm font-medium text-gray-400 mb-3">Backends</h2>
          <div class="space-y-2">
            {toolMeta.backends.map(backend => {
              const url = backendToUrl(backend);
              return (
                <div class="flex items-center justify-between">
                  <code class="text-sm text-gray-300 font-mono">{backend}</code>
                  {url && (
                    <a href={url} target="_blank" rel="noopener noreferrer" class="text-neon-purple hover:text-neon-pink transition-colors text-sm">
                      View →
                    </a>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      )}

      <!-- Links -->
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
        <h2 class="text-sm font-medium text-gray-400 mb-3">Links</h2>
        <div class="space-y-2">
          {toolMeta.homepage && (
            <a href={toolMeta.homepage} target="_blank" rel="noopener noreferrer" class="block text-sm text-neon-purple hover:text-neon-pink transition-colors">
              Homepage →
            </a>
          )}
          {toolMeta.repo_url && (
            <a href={toolMeta.repo_url} target="_blank" rel="noopener noreferrer" class="block text-sm text-neon-purple hover:text-neon-pink transition-colors">
              Repository →
            </a>
          )}
          {toolMeta.github && (
            <a href={`https://github.com/${toolMeta.github}`} target="_blank" rel="noopener noreferrer" class="block text-sm text-neon-purple hover:text-neon-pink transition-colors">
              GitHub →
            </a>
          )}
          {toolMeta.license && (
            <div class="text-sm text-gray-400">License: {toolMeta.license}</div>
          )}
        </div>
      </div>
    </div>

    <!-- Versions List -->
    <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
      <h2 class="text-lg font-semibold text-gray-200 mb-4">Versions ({versions.length})</h2>
      <div class="max-h-96 overflow-y-auto">
        <table class="w-full">
          <thead class="bg-dark-700 sticky top-0">
            <tr>
              <th class="text-left px-3 py-2 text-sm font-medium text-gray-400">Version</th>
              <th class="text-left px-3 py-2 text-sm font-medium text-gray-400 hidden sm:table-cell">Released</th>
              <th class="text-right px-3 py-2 text-sm font-medium text-gray-400">Downloads</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-dark-600">
            {versions.slice(0, 50).map(v => {
              const versionStats = downloadStats.byVersion.find(s => s.version === v.version);
              return (
                <tr class="hover:bg-dark-700 transition-colors">
                  <td class="px-3 py-2 font-mono text-sm text-gray-200">{v.version}</td>
                  <td class="px-3 py-2 text-sm text-gray-400 hidden sm:table-cell">
                    {v.created_at ? new Date(v.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '-'}
                  </td>
                  <td class="px-3 py-2 text-sm text-gray-400 text-right">
                    {versionStats?.count.toLocaleString() || '0'}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
        {versions.length > 50 && (
          <div class="text-center py-3 text-sm text-gray-500">
            Showing 50 of {versions.length} versions
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>

<script>
  document.getElementById('copyBtn')?.addEventListener('click', () => {
    const tool = window.location.pathname.split('/').pop();
    navigator.clipboard.writeText(`mise use -g ${tool}@latest`);
  });
</script>
