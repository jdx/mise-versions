---
import Layout from '../../layouts/Layout.astro';
import { drizzle } from 'drizzle-orm/d1';
import { sql } from 'drizzle-orm';
import { setupAnalytics } from '../../../../src/analytics';
import { InfoPane } from '../../components/InfoPane';
import { DownloadsPane } from '../../components/DownloadsPane';
import { VersionsTable } from '../../components/VersionsTable';
import { getLatestStableVersion } from '../../lib/versions';
import { loadToolsJson } from '../../lib/data-loader';

const { tool } = Astro.params;

if (!tool) {
  return Astro.redirect('/');
}

const runtime = Astro.locals.runtime;
const db = drizzle(runtime.env.ANALYTICS_DB);

// Load tools from D1 database
const toolsData = await loadToolsJson(runtime.env.ANALYTICS_DB);
if (!toolsData) {
  return Astro.redirect('/');
}

const toolMeta = toolsData.tools.find(t => t.name === tool);

if (!toolMeta) {
  return Astro.redirect('/');
}

// Load versions from D1 database
let versions: Array<{ version: string; created_at?: string | null; release_url?: string | null }> = [];
try {
  // Get tool_id first
  const toolResult = await db.all<{ id: number }>(sql`
    SELECT id FROM tools WHERE name = ${tool}
  `);

  if (toolResult.length > 0) {
    const toolId = toolResult[0].id;
    const versionRows = await db.all<{ version: string; created_at: string | null; release_url: string | null }>(sql`
      SELECT version, created_at, release_url
      FROM versions
      WHERE tool_id = ${toolId}
      ORDER BY id ASC
    `);
    versions = versionRows.map(row => ({
      version: row.version,
      created_at: row.created_at || null,
      release_url: row.release_url || null,
    }));
  }
} catch (e) {
  console.error('Failed to load versions from D1:', e);
}

// Fetch download stats
let downloadStats: {
  total: number;
  daily: Array<{ date: string; count: number }>;
  monthly: Array<{ month: string; count: number }>;
  byVersion: Array<{ version: string; count: number }>;
  byOs?: Array<{ os: string | null; count: number }>;
} = { total: 0, daily: [], monthly: [], byVersion: [] };

try {
  const runtime = Astro.locals.runtime;
  const db = drizzle(runtime.env.ANALYTICS_DB);
  const analytics = setupAnalytics(db);
  downloadStats = await analytics.getDownloadStats(tool);
} catch (e) {
  console.error('Failed to fetch download stats:', e);
}

// Create downloads by version map for the versions table
const downloadsByVersion: Record<string, number> = {};
for (const v of downloadStats.byVersion) {
  downloadsByVersion[v.version] = v.count;
}

// Get page title and description
const pageTitle = tool;
const pageDescription = toolMeta.description || `${tool} - version manager tool`;

// Compute latest stable version (prefer stable, fall back to any latest)
const latestStable = getLatestStableVersion(versions);
const latestVersion = versions[versions.length - 1]?.version || toolMeta.latest_version;
const latestStableVersion = latestStable?.version || latestVersion;

// Backend URL helper
function backendToUrl(backend: string): string | null {
  const match = backend.match(/^(?<prefix>.+?):(?<slug>.+?)(?:\[.+\])?$/);
  if (!match?.groups) return null;
  const { prefix, slug } = match.groups;
  switch (prefix) {
    case 'npm': return `https://www.npmjs.com/package/${slug}`;
    case 'cargo': return `https://crates.io/crates/${slug}`;
    case 'pipx': return `https://pypi.org/project/${slug}`;
    case 'gem': return `https://rubygems.org/gems/${slug}`;
    case 'go': return `https://pkg.go.dev/${slug}`;
    case 'aqua':
    case 'github':
    case 'ubi':
    case 'asdf':
    case 'vfox':
      return `https://github.com/${slug.split('/').slice(0, 2).join('/')}`;
    case 'core': return `https://mise.jdx.dev/lang/${slug}.html`;
    default: return null;
  }
}

---

<Layout title={pageTitle} description={pageDescription}>
  <div>
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-100 mb-2">{tool}</h1>
      {toolMeta.description && (
        <p class="text-gray-400 mb-2">{toolMeta.description}</p>
      )}
      <div class="text-sm text-gray-500 flex flex-wrap items-center gap-x-1">
        {toolMeta.backends?.[0] && (() => {
          const backend = toolMeta.backends[0];
          const url = backendToUrl(backend);
          return url ? (
            <>
              <a
                href={url}
                target="_blank"
                rel="noopener noreferrer"
                class="font-mono text-neon-blue hover:text-neon-purple transition-colors"
              >
                {backend.replace(/\[.*\]$/, "")}
              </a>
              <span>路</span>
            </>
          ) : (
            <>
              <span class="font-mono">{backend.replace(/\[.*\]$/, "")}</span>
              <span>路</span>
            </>
          );
        })()}
        {latestStableVersion && (
          <>
            <span class="font-mono text-gray-300">{latestStableVersion}</span>
            <span>路</span>
          </>
        )}
        <span>{versions.length} versions</span>
        {downloadStats.total > 0 && (
          <>
            <span>路</span>
            <span>{downloadStats.total.toLocaleString()} downloads</span>
          </>
        )}
      </div>
    </div>

    <!-- Two-column layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <!-- Left column: Info -->
      <InfoPane client:load tool={tool} toolMeta={toolMeta} />

      <!-- Right column: Downloads -->
      <DownloadsPane
        client:load
        tool={tool}
        daily={downloadStats.daily}
        monthly={downloadStats.monthly}
        byVersion={downloadStats.byVersion}
        byOs={downloadStats.byOs}
      />
    </div>

    <!-- Versions Table (includes timeline) -->
    <VersionsTable
      client:load
      versions={versions}
      downloadsByVersion={downloadsByVersion}
      github={toolMeta.github}
      tool={tool}
    />
  </div>
</Layout>
