---
import Layout from '../../layouts/Layout.astro';
import { drizzle } from 'drizzle-orm/d1';
import { setupAnalytics } from '../../../../src/analytics';
import * as smolToml from 'smol-toml';
import { InfoPane } from '../../components/InfoPane';
import { DownloadsPane } from '../../components/DownloadsPane';
import { VersionsTable } from '../../components/VersionsTable';
import { isPrerelease, getLatestStableVersion } from '../../lib/versions';

const { tool } = Astro.params;

if (!tool) {
  return Astro.redirect('/');
}

// Fetch tools.json directly from GitHub Pages (avoid subrequest to same Worker)
// Cache for 10 minutes at Cloudflare edge
const toolsRes = await fetch('https://mise-versions.jdx.dev/tools.json', {
  cf: { cacheTtl: 600 },
});
const toolsData = await toolsRes.json() as {
  tools: Array<{
    name: string;
    latest_version: string;
    version_count: number;
    last_updated: string | null;
    description?: string;
    backends?: string[];
    homepage?: string;
    repo_url?: string;
    license?: string;
    github?: string;
    authors?: string[];
    security?: Array<{ type: string; algorithm?: string }>;
    package_urls?: Record<string, string>;
    aqua_link?: string;
  }>;
};

const toolMeta = toolsData.tools.find(t => t.name === tool);

if (!toolMeta) {
  return Astro.redirect('/');
}

// Fetch versions from TOML file directly from GitHub Pages
// Cache for 10 minutes at Cloudflare edge
let versions: Array<{ version: string; created_at?: string | null }> = [];
try {
  const tomlRes = await fetch(`https://mise-versions.jdx.dev/${tool}.toml`, {
    cf: { cacheTtl: 600 },
  });
  if (tomlRes.ok) {
    const tomlText = await tomlRes.text();
    // TOML format: [versions] with "version" = { created_at = ... } entries
    const parsed = smolToml.parse(tomlText) as { versions?: Record<string, { created_at?: string }> };
    const versionsObj = parsed.versions || {};
    versions = Object.entries(versionsObj).map(([version, data]) => ({
      version,
      created_at: data?.created_at || null,
    }));
  }
} catch (e) {
  console.error('Failed to fetch versions TOML:', e);
}

// Fetch download stats
let downloadStats: {
  total: number;
  daily: Array<{ date: string; count: number }>;
  monthly: Array<{ month: string; count: number }>;
  byVersion: Array<{ version: string; count: number }>;
  byOs?: Array<{ os: string | null; count: number }>;
} = { total: 0, daily: [], monthly: [], byVersion: [] };

try {
  const runtime = Astro.locals.runtime;
  const db = drizzle(runtime.env.ANALYTICS_DB);
  const analytics = setupAnalytics(db);
  downloadStats = await analytics.getDownloadStats(tool);
} catch (e) {
  console.error('Failed to fetch download stats:', e);
}

// Create downloads by version map for the versions table
const downloadsByVersion: Record<string, number> = {};
for (const v of downloadStats.byVersion) {
  downloadsByVersion[v.version] = v.count;
}

// Get page title and description
const pageTitle = tool;
const pageDescription = toolMeta.description || `${tool} - version manager tool`;

// Compute latest version info
const latestVersion = versions[versions.length - 1]?.version || toolMeta.latest_version;
const latestIsPrerelease = latestVersion ? isPrerelease(latestVersion) : false;
const latestStable = getLatestStableVersion(versions);
const latestStableVersion = latestStable?.version;

// Backend URL helper
function backendToUrl(backend: string): string | null {
  const match = backend.match(/^(?<prefix>.+?):(?<slug>.+?)(?:\[.+\])?$/);
  if (!match?.groups) return null;
  const { prefix, slug } = match.groups;
  switch (prefix) {
    case 'npm': return `https://www.npmjs.com/package/${slug}`;
    case 'cargo': return `https://crates.io/crates/${slug}`;
    case 'pipx': return `https://pypi.org/project/${slug}`;
    case 'gem': return `https://rubygems.org/gems/${slug}`;
    case 'go': return `https://pkg.go.dev/${slug}`;
    case 'aqua':
    case 'github':
    case 'ubi':
    case 'asdf':
    case 'vfox':
      return `https://github.com/${slug.split('/').slice(0, 2).join('/')}`;
    case 'core': return `https://mise.jdx.dev/lang/${slug}.html`;
    default: return null;
  }
}

// Build release timeline milestones for server-rendered component
function buildTimelineMilestones(versions: Array<{ version: string; created_at?: string | null }>) {
  const datedVersions = versions
    .filter((v) => v.created_at)
    .sort((a, b) => new Date(a.created_at!).getTime() - new Date(b.created_at!).getTime());

  if (datedVersions.length < 2) return null;

  const milestones: Array<{ version: string; date: Date; isMajor: boolean }> = [];
  const reversedVersions = [...datedVersions].reverse();
  const seenMajors = new Set<string>();
  const seenMinors = new Set<string>();
  const latestMajor = reversedVersions[0]?.version.split(".")[0];

  for (const v of reversedVersions) {
    const parts = v.version.split(".");
    if (parts.length < 2) continue;

    const major = parts[0];
    const minor = `${parts[0]}.${parts[1]}`;
    const isMinorZero = parts[1] === "0" || parts[1] === "";

    if (isMinorZero && !seenMajors.has(major) && seenMajors.size < 5) {
      seenMajors.add(major);
      seenMinors.add(minor);
      milestones.push({
        version: v.version,
        date: new Date(v.created_at!),
        isMajor: true,
      });
    } else if (major === latestMajor && !seenMinors.has(minor) && milestones.length < 10) {
      seenMinors.add(minor);
      milestones.push({
        version: v.version,
        date: new Date(v.created_at!),
        isMajor: false,
      });
    }

    if (milestones.length >= 10) break;
  }

  milestones.sort((a, b) => a.date.getTime() - b.date.getTime());

  const latest = datedVersions[datedVersions.length - 1];
  if (!milestones.some((m) => m.version === latest.version)) {
    milestones.push({
      version: latest.version,
      date: new Date(latest.created_at!),
      isMajor: false,
    });
  }

  const displayMilestones = milestones.slice(-10);
  if (displayMilestones.length < 2) return null;

  const firstDate = displayMilestones[0].date.getTime();
  const lastDate = displayMilestones[displayMilestones.length - 1].date.getTime();
  const range = lastDate - firstDate || 1;
  const totalDays = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
  const avgDaysBetween = totalDays / (datedVersions.length - 1);

  return {
    milestones: displayMilestones.map(m => ({
      ...m,
      position: ((m.date.getTime() - firstDate) / range) * 100,
      dateStr: m.date.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }),
      shortVersion: m.version.split(".").slice(0, m.isMajor ? 1 : 2).join("."),
    })),
    totalReleases: datedVersions.length,
    totalDays,
    avgDaysBetween,
  };
}

const timeline = buildTimelineMilestones(versions);
---

<Layout title={pageTitle} description={pageDescription}>
  <div>
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-100 mb-2">{tool}</h1>
      {toolMeta.description && (
        <p class="text-gray-400 mb-2">{toolMeta.description}</p>
      )}
      <div class="text-sm text-gray-500 flex flex-wrap items-center gap-x-1">
        {toolMeta.backends?.[0] && (() => {
          const backend = toolMeta.backends[0];
          const url = backendToUrl(backend);
          return url ? (
            <>
              <a
                href={url}
                target="_blank"
                rel="noopener noreferrer"
                class="font-mono text-neon-blue hover:text-neon-purple transition-colors"
              >
                {backend.replace(/\[.*\]$/, "")}
              </a>
              <span>路</span>
            </>
          ) : (
            <>
              <span class="font-mono">{backend.replace(/\[.*\]$/, "")}</span>
              <span>路</span>
            </>
          );
        })()}
        {latestVersion && (
          <>
            <span class="font-mono text-gray-300">
              {latestIsPrerelease ? (
                <>
                  <span class="text-yellow-500" title="Prerelease">{latestVersion}</span>
                  {latestStableVersion && latestStableVersion !== latestVersion && (
                    <span class="text-gray-500"> (stable: {latestStableVersion})</span>
                  )}
                </>
              ) : (
                latestVersion
              )}
            </span>
            <span>路</span>
          </>
        )}
        <span>{versions.length} versions</span>
        {downloadStats.total > 0 && (
          <>
            <span>路</span>
            <span>{downloadStats.total.toLocaleString()} downloads</span>
          </>
        )}
      </div>
    </div>

    <!-- Two-column layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <!-- Left column: Info -->
      <InfoPane client:load tool={tool} toolMeta={toolMeta} />

      <!-- Right column: Downloads -->
      <DownloadsPane
        client:load
        tool={tool}
        daily={downloadStats.daily}
        monthly={downloadStats.monthly}
        byVersion={downloadStats.byVersion}
        byOs={downloadStats.byOs}
      />
    </div>

    <!-- Version Timeline (server-rendered) -->
    {timeline && (
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300">Release Timeline</h3>
          <div class="text-xs text-gray-500">
            {timeline.totalReleases} releases over{" "}
            {Math.round(timeline.totalDays / 365) > 0
              ? `${Math.round(timeline.totalDays / 365)}y`
              : `${Math.round(timeline.totalDays)}d`}
            {timeline.avgDaysBetween > 0 && (
              <span class="ml-2">
                (~{timeline.avgDaysBetween < 30 ? `${Math.round(timeline.avgDaysBetween)}d` : `${Math.round(timeline.avgDaysBetween / 30)}mo`} avg)
              </span>
            )}
          </div>
        </div>

        <!-- Timeline -->
        <div class="relative h-16">
          <!-- Line -->
          <div class="absolute top-6 left-0 right-0 h-0.5 bg-dark-600" />

          <!-- Milestones -->
          {timeline.milestones.map((m) => (
            <div
              class="absolute -translate-x-1/2 group"
              style={`left: ${Math.min(Math.max(m.position, 2), 98)}%`}
            >
              <!-- Dot -->
              <div
                class={`w-3 h-3 rounded-full mt-5 ${
                  m.isMajor ? "bg-neon-purple" : "bg-neon-blue"
                } hover:ring-2 hover:ring-neon-purple/50 transition-all cursor-pointer`}
              />
              <!-- Label -->
              <div class="absolute top-8 left-1/2 -translate-x-1/2 text-xs whitespace-nowrap">
                <span class={`font-mono ${m.isMajor ? "text-gray-300" : "text-gray-500"}`}>
                  {m.shortVersion}
                </span>
              </div>
              <!-- Tooltip -->
              <div class="absolute bottom-8 left-1/2 -translate-x-1/2 mb-1 px-2 py-1 bg-dark-700 rounded text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10 border border-dark-600">
                <div class="font-mono text-neon-purple">{m.version}</div>
                <div class="text-gray-500">{m.dateStr}</div>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Versions Table -->
    <VersionsTable
      client:load
      versions={versions}
      downloadsByVersion={downloadsByVersion}
    />
  </div>
</Layout>
