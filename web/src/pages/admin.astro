---
import Layout from '../layouts/Layout.astro';
import { getAuthCookie } from '../lib/auth';
import { isAdmin } from '../lib/admin';

// Server-side admin check
const runtime = Astro.locals.runtime;
const auth = await getAuthCookie(Astro.request, runtime.env.API_SECRET);

if (!auth || !isAdmin(auth.username)) {
  return Astro.redirect('/');
}
---

<Layout title="Admin" description="Admin dashboard">
  <div class="space-y-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-100">Admin Dashboard</h1>
      <p class="text-gray-400 text-sm mt-1">Token pool management and system status</p>
    </div>

    <!-- D1 Table Counts Card -->
    <div class="bg-dark-800 border border-dark-600 rounded-lg overflow-hidden">
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-6">
          <h2 class="text-lg font-semibold text-gray-200">D1 Table Counts</h2>
          <div id="table-counts-inline-stats" class="flex items-center gap-4 text-sm">
            <span class="text-gray-500">Loading...</span>
          </div>
        </div>
        <button
          id="table-counts-expand-btn"
          class="px-3 py-1.5 bg-dark-700 hover:bg-dark-600 border border-dark-500 rounded-lg text-sm text-gray-300 hover:text-white transition-colors flex items-center gap-1"
        >
          <span id="table-counts-expand-text">Expand</span>
          <svg id="table-counts-expand-icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
      </div>

      <!-- Expanded content -->
      <div id="table-counts-expanded-content" class="hidden">
        <div class="border-t border-dark-600"></div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-dark-700">
              <tr>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Table</th>
                <th class="px-4 py-2 text-right text-sm font-medium text-gray-400">Count</th>
              </tr>
            </thead>
            <tbody id="table-counts-body" class="divide-y divide-dark-600">
              <tr>
                <td colspan="2" class="px-4 py-8 text-center text-gray-500">
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ASDF-Primary Tools Card -->
    <div class="bg-dark-800 border border-dark-600 rounded-lg overflow-hidden">
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-6">
          <h2 class="text-lg font-semibold text-gray-200">ASDF-Primary Tools</h2>
          <div id="asdf-inline-stats" class="flex items-center gap-4 text-sm">
            <span class="text-gray-500">Loading...</span>
          </div>
        </div>
        <button
          id="asdf-expand-btn"
          class="px-3 py-1.5 bg-dark-700 hover:bg-dark-600 border border-dark-500 rounded-lg text-sm text-gray-300 hover:text-white transition-colors flex items-center gap-1"
        >
          <span id="asdf-expand-text">Expand</span>
          <svg id="asdf-expand-icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
      </div>

      <!-- Expanded content -->
      <div id="asdf-expanded-content" class="hidden">
        <div class="border-t border-dark-600"></div>
        <div class="overflow-x-auto max-h-96 overflow-y-auto">
          <table class="w-full">
            <thead class="bg-dark-700 sticky top-0">
              <tr>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">#</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Tool</th>
                <th class="px-4 py-2 text-right text-sm font-medium text-gray-400">30d Downloads</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Backend</th>
              </tr>
            </thead>
            <tbody id="asdf-table-body" class="divide-y divide-dark-600">
              <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Token Pool Card (collapsible) -->
    <div class="bg-dark-800 border border-dark-600 rounded-lg overflow-hidden">
      <!-- Header with stats summary (always visible) -->
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-6">
          <h2 class="text-lg font-semibold text-gray-200">Token Pool</h2>
          <!-- Inline stats (visible when collapsed) -->
          <div id="inline-stats" class="flex items-center gap-4 text-sm">
            <span class="text-gray-500">Loading...</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button
            id="delete-invalid-btn"
            class="hidden px-3 py-1.5 bg-red-900/50 hover:bg-red-900 border border-red-700 rounded-lg text-sm text-red-300 hover:text-red-100 transition-colors"
          >
            Delete Invalid Tokens
          </button>
          <button
            id="test-tokens-btn"
            class="hidden px-3 py-1.5 bg-dark-700 hover:bg-dark-600 border border-dark-500 rounded-lg text-sm text-gray-300 hover:text-white transition-colors"
          >
            Test All Tokens
          </button>
          <button
            id="expand-btn"
            class="px-3 py-1.5 bg-dark-700 hover:bg-dark-600 border border-dark-500 rounded-lg text-sm text-gray-300 hover:text-white transition-colors flex items-center gap-1"
          >
            <span id="expand-text">Expand</span>
            <svg id="expand-icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Expiring Tokens Alert (inside card, visible when expanded) -->
      <div id="expiring-alert" class="hidden mx-4 mb-4 bg-orange-900/20 border border-orange-500/30 rounded-lg p-4">
        <h3 class="text-orange-400 font-medium mb-2">Tokens Expiring Soon (24h)</h3>
        <div id="expiring-list" class="space-y-1"></div>
      </div>

      <!-- Expanded content -->
      <div id="expanded-content" class="hidden">
        <div class="border-t border-dark-600"></div>
        <div class="relative">
          <!-- Loading overlay -->
          <div id="table-loading-overlay" class="hidden absolute inset-0 bg-dark-900/70 z-10 flex items-center justify-center">
            <div class="flex flex-col items-center gap-2">
              <svg class="animate-spin h-8 w-8 text-neon-purple" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-sm text-gray-400">Testing tokens...</span>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-dark-700">
                <tr>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">User</th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Usage</th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Last Used</th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Status</th>
                  <th class="px-4 py-2 text-left text-sm font-medium text-gray-400 w-20"></th>
                </tr>
              </thead>
              <tbody id="token-table-body" class="divide-y divide-dark-600">
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // D1 Table Counts functionality
  let tableCountsData: Record<string, number> = {};
  let isTableCountsExpanded = false;

  function toggleTableCountsExpanded() {
    isTableCountsExpanded = !isTableCountsExpanded;
    const expandedContent = document.getElementById('table-counts-expanded-content');
    const expandText = document.getElementById('table-counts-expand-text');
    const expandIcon = document.getElementById('table-counts-expand-icon');

    if (isTableCountsExpanded) {
      expandedContent?.classList.remove('hidden');
      if (expandText) expandText.textContent = 'Collapse';
      expandIcon?.classList.add('rotate-180');
    } else {
      expandedContent?.classList.add('hidden');
      if (expandText) expandText.textContent = 'Expand';
      expandIcon?.classList.remove('rotate-180');
    }
  }

  function renderTableCounts() {
    const tableBody = document.getElementById('table-counts-body');
    if (!tableBody) return;

    const entries = Object.entries(tableCountsData);
    if (entries.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="2" class="px-4 py-8 text-center text-gray-500">No tables found</td>
        </tr>
      `;
      return;
    }

    tableBody.innerHTML = entries.map(([table, count]) => `
      <tr class="hover:bg-dark-700/50">
        <td class="px-4 py-2 text-gray-300 font-mono">${table}</td>
        <td class="px-4 py-2 text-right text-gray-300 font-mono">${count >= 0 ? count.toLocaleString() : '<span class="text-gray-500">N/A</span>'}</td>
      </tr>
    `).join('');
  }

  async function loadTableCounts() {
    try {
      const response = await fetch('/api/admin/table-counts');
      if (!response.ok) {
        throw new Error('Failed to load table counts');
      }
      const data = await response.json();
      tableCountsData = data.counts;

      // Calculate total rows
      const totalRows = Object.values(tableCountsData).reduce((sum, count) => sum + (count >= 0 ? count : 0), 0);
      const tableCount = Object.keys(tableCountsData).length;

      // Update inline stats
      const inlineStats = document.getElementById('table-counts-inline-stats');
      if (inlineStats) {
        inlineStats.innerHTML = `
          <span class="text-neon-cyan">${tableCount} tables</span>
          <span class="text-gray-600">|</span>
          <span class="text-gray-400">${totalRows.toLocaleString()} total rows</span>
        `;
      }

      renderTableCounts();
    } catch (error) {
      console.error('Failed to load table counts:', error);
      const inlineStats = document.getElementById('table-counts-inline-stats');
      if (inlineStats) {
        inlineStats.innerHTML = '<span class="text-red-400">Failed to load</span>';
      }
      const tableBody = document.getElementById('table-counts-body');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="2" class="px-4 py-8 text-center text-red-400">Failed to load data</td>
          </tr>
        `;
      }
    }
  }

  // ASDF-Primary Tools functionality
  interface AsdfPrimaryTool {
    name: string;
    downloads_30d: number;
    asdf_backend: string;
  }

  let asdfToolsData: AsdfPrimaryTool[] = [];
  let isAsdfExpanded = false;

  function toggleAsdfExpanded() {
    isAsdfExpanded = !isAsdfExpanded;
    const expandedContent = document.getElementById('asdf-expanded-content');
    const expandText = document.getElementById('asdf-expand-text');
    const expandIcon = document.getElementById('asdf-expand-icon');

    if (isAsdfExpanded) {
      expandedContent?.classList.remove('hidden');
      if (expandText) expandText.textContent = 'Collapse';
      expandIcon?.classList.add('rotate-180');
    } else {
      expandedContent?.classList.add('hidden');
      if (expandText) expandText.textContent = 'Expand';
      expandIcon?.classList.remove('rotate-180');
    }
  }

  function renderAsdfTable() {
    const tableBody = document.getElementById('asdf-table-body');
    if (!tableBody) return;

    if (asdfToolsData.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="4" class="px-4 py-8 text-center text-gray-500">No asdf-primary tools found</td>
        </tr>
      `;
      return;
    }

    tableBody.innerHTML = asdfToolsData.map((tool, index) => `
      <tr class="hover:bg-dark-700/50">
        <td class="px-4 py-2 text-gray-500 text-sm">${index + 1}</td>
        <td class="px-4 py-2">
          <a href="/tools/${tool.name}" class="text-neon-cyan hover:underline">${tool.name}</a>
        </td>
        <td class="px-4 py-2 text-right text-gray-300 font-mono">${tool.downloads_30d.toLocaleString()}</td>
        <td class="px-4 py-2 text-gray-400 text-sm font-mono">${tool.asdf_backend}</td>
      </tr>
    `).join('');
  }

  async function loadAsdfPrimaryData() {
    try {
      const response = await fetch('/api/admin/asdf-primary');
      if (!response.ok) {
        throw new Error('Failed to load asdf-primary data');
      }
      const data = await response.json();
      asdfToolsData = data.tools;

      // Update inline stats
      const inlineStats = document.getElementById('asdf-inline-stats');
      if (inlineStats) {
        inlineStats.innerHTML = `
          <span class="text-neon-cyan">${data.total} tools</span>
          <span class="text-gray-600">|</span>
          <span class="text-gray-400">${data.total_downloads?.toLocaleString() || 0} downloads (30d)</span>
        `;
      }

      renderAsdfTable();
    } catch (error) {
      console.error('Failed to load asdf-primary data:', error);
      const inlineStats = document.getElementById('asdf-inline-stats');
      if (inlineStats) {
        inlineStats.innerHTML = '<span class="text-red-400">Failed to load</span>';
      }
      const tableBody = document.getElementById('asdf-table-body');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-4 py-8 text-center text-red-400">Failed to load data</td>
          </tr>
        `;
      }
    }
  }

  // Store token data globally for test results
  let tokenData: Array<{
    id: number;
    user_name: string | null;
    user_id: string | null;
    usage_count: number;
    last_used: string | null;
    is_active: number;
    rate_limited_at: string | null;
    expires_at: string | null;
  }> = [];

  // Store test results
  let testResults: Map<number, { valid: boolean; error?: string; rateLimit?: { remaining: number; limit: number } }> = new Map();

  // Track expanded state
  let isExpanded = false;

  function toggleExpanded() {
    isExpanded = !isExpanded;
    const expandedContent = document.getElementById('expanded-content');
    const expandText = document.getElementById('expand-text');
    const expandIcon = document.getElementById('expand-icon');
    const testBtn = document.getElementById('test-tokens-btn');
    const deleteInvalidBtn = document.getElementById('delete-invalid-btn');

    if (isExpanded) {
      expandedContent?.classList.remove('hidden');
      if (expandText) expandText.textContent = 'Collapse';
      expandIcon?.classList.add('rotate-180');
      testBtn?.classList.remove('hidden');
      // Show delete invalid button if there are invalid tokens
      updateDeleteInvalidButton();
    } else {
      expandedContent?.classList.add('hidden');
      if (expandText) expandText.textContent = 'Expand';
      expandIcon?.classList.remove('rotate-180');
      testBtn?.classList.add('hidden');
      deleteInvalidBtn?.classList.add('hidden');
    }
  }

  function getInvalidTokenIds(): number[] {
    const invalidIds: number[] = [];
    testResults.forEach((result, id) => {
      if (!result.valid) {
        invalidIds.push(id);
      }
    });
    return invalidIds;
  }

  function updateDeleteInvalidButton() {
    const btn = document.getElementById('delete-invalid-btn');
    if (!btn) return;

    const invalidIds = getInvalidTokenIds();
    if (invalidIds.length > 0 && isExpanded) {
      btn.classList.remove('hidden');
      btn.textContent = `Delete Invalid (${invalidIds.length})`;
    } else {
      btn.classList.add('hidden');
    }
  }

  function renderTokenTable() {
    const tableBody = document.getElementById('token-table-body');
    if (!tableBody) return;

    if (tokenData.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-gray-500">No tokens in pool</td>
        </tr>
      `;
      return;
    }

    // Sort by user_id (username)
    const sortedTokens = [...tokenData].sort((a, b) => {
      const aName = (a.user_id || '').toLowerCase();
      const bName = (b.user_id || '').toLowerCase();
      return aName.localeCompare(bName);
    });

    tableBody.innerHTML = sortedTokens.map((t) => {
      const isRateLimited = t.rate_limited_at && new Date(t.rate_limited_at) > new Date();
      const testResult = testResults.get(t.id);

      let statusClass = isRateLimited ? 'text-orange-400' : (t.is_active ? 'text-green-400' : 'text-red-400');
      let statusText = isRateLimited ? 'Rate Limited' : (t.is_active ? 'Active' : 'Inactive');

      // Override with test result if available
      if (testResult) {
        if (testResult.valid) {
          statusClass = 'text-green-400';
          statusText = testResult.rateLimit ? `Valid (${testResult.rateLimit.remaining}/${testResult.rateLimit.limit})` : 'Valid';
        } else {
          statusClass = 'text-red-400';
          statusText = 'Invalid';
        }
      }

      return `
        <tr class="hover:bg-dark-700/50" data-token-id="${t.id}">
          <td class="px-4 py-3">
            <div class="text-gray-200">${t.user_id || 'Unknown'}</div>
            <div class="text-xs text-gray-500">${t.user_name || ''}</div>
          </td>
          <td class="px-4 py-3 text-gray-300">${t.usage_count.toLocaleString()}</td>
          <td class="px-4 py-3 text-gray-400 text-sm">${t.last_used ? new Date(t.last_used).toLocaleString() : 'Never'}</td>
          <td class="px-4 py-3">
            <span class="${statusClass} text-sm">${statusText}</span>
          </td>
          <td class="px-4 py-3">
            <button
              onclick="deleteToken(${t.id})"
              class="text-gray-500 hover:text-red-400 transition-colors"
              title="Delete token"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function deleteToken(tokenId: number) {
    if (!confirm('Are you sure you want to delete this token?')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/tokens/${tokenId}`, { method: 'DELETE' });
      if (!response.ok) {
        throw new Error('Failed to delete token');
      }

      // Remove from local data and re-render
      tokenData = tokenData.filter(t => t.id !== tokenId);
      testResults.delete(tokenId);
      renderTokenTable();
      updateDeleteInvalidButton();

      // Reload stats
      loadAdminData();
    } catch (error) {
      console.error('Failed to delete token:', error);
      alert('Failed to delete token');
    }
  }

  async function deleteInvalidTokens() {
    const invalidIds = getInvalidTokenIds();
    if (invalidIds.length === 0) return;

    if (!confirm(`Are you sure you want to delete ${invalidIds.length} invalid token(s)?`)) {
      return;
    }

    const btn = document.getElementById('delete-invalid-btn') as HTMLButtonElement;
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Deleting...';
    }

    try {
      const response = await fetch('/api/admin/tokens/delete-batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: invalidIds }),
      });

      if (!response.ok) {
        throw new Error('Failed to delete tokens');
      }

      // Remove from local data and re-render
      tokenData = tokenData.filter(t => !invalidIds.includes(t.id));
      invalidIds.forEach(id => testResults.delete(id));
      renderTokenTable();
      updateDeleteInvalidButton();

      // Reload stats
      loadAdminData();
    } catch (error) {
      console.error('Failed to delete invalid tokens:', error);
      alert('Failed to delete invalid tokens');
    } finally {
      if (btn) {
        btn.disabled = false;
        updateDeleteInvalidButton();
      }
    }
  }

  function updateInlineStats(stats: { active: number; total: number }, rateLimitedCount: number, expiringSoonCount: number) {
    const inlineStats = document.getElementById('inline-stats');
    if (!inlineStats) return;

    inlineStats.innerHTML = `
      <span class="text-green-400">${stats.active} active</span>
      <span class="text-gray-600">|</span>
      <span class="text-gray-400">${stats.total} total</span>
      ${rateLimitedCount > 0 ? `<span class="text-gray-600">|</span><span class="text-orange-400">${rateLimitedCount} rate limited</span>` : ''}
      ${expiringSoonCount > 0 ? `<span class="text-gray-600">|</span><span class="text-orange-400">${expiringSoonCount} expiring</span>` : ''}
    `;
  }

  async function loadAdminData() {
    try {
      const response = await fetch('/api/admin/tokens');
      if (!response.ok) {
        throw new Error('Failed to load admin data');
      }
      const data = await response.json();
      tokenData = data.tokens;

      // Count rate-limited tokens
      const rateLimitedCount = data.tokens.filter((t: { rate_limited_at: string | null }) => {
        if (!t.rate_limited_at) return false;
        return new Date(t.rate_limited_at) > new Date();
      }).length;

      // Update inline stats
      updateInlineStats(data.stats, rateLimitedCount, data.expiringSoon.length);

      // Show expiring tokens alert if any (when expanded)
      const alertContainer = document.getElementById('expiring-alert');
      const expiringList = document.getElementById('expiring-list');
      if (alertContainer && expiringList) {
        if (data.expiringSoon.length > 0) {
          alertContainer.classList.remove('hidden');
          expiringList.innerHTML = data.expiringSoon.map((t: { user_name: string | null; expires_at: string }) => `
            <div class="text-sm text-orange-300">${t.user_name || 'Unknown'} - expires ${new Date(t.expires_at).toLocaleString()}</div>
          `).join('');
        } else {
          alertContainer.classList.add('hidden');
        }
      }

      // Render token table
      renderTokenTable();
    } catch (error) {
      console.error('Failed to load admin data:', error);
      const inlineStats = document.getElementById('inline-stats');
      if (inlineStats) {
        inlineStats.innerHTML = '<span class="text-red-400">Failed to load</span>';
      }
      const tableBody = document.getElementById('token-table-body');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-red-400">Failed to load data</td>
          </tr>
        `;
      }
    }
  }

  async function testAllTokens() {
    const btn = document.getElementById('test-tokens-btn') as HTMLButtonElement;
    const overlay = document.getElementById('table-loading-overlay');
    if (!btn) return;

    btn.disabled = true;
    btn.textContent = 'Testing...';
    overlay?.classList.remove('hidden');

    try {
      const response = await fetch('/api/admin/tokens/test', { method: 'POST' });
      if (!response.ok) {
        throw new Error('Failed to test tokens');
      }
      const data = await response.json();

      // Store results
      testResults.clear();
      for (const result of data.results) {
        testResults.set(result.id, {
          valid: result.valid,
          error: result.error,
          rateLimit: result.rateLimit,
        });
      }

      // Re-render table with results
      renderTokenTable();
      updateDeleteInvalidButton();

      btn.textContent = `Tested: ${data.summary.valid}/${data.summary.total} valid`;
      setTimeout(() => {
        btn.textContent = 'Test All Tokens';
      }, 3000);
    } catch (error) {
      console.error('Failed to test tokens:', error);
      btn.textContent = 'Test Failed';
      setTimeout(() => {
        btn.textContent = 'Test All Tokens';
      }, 3000);
    } finally {
      btn.disabled = false;
      overlay?.classList.add('hidden');
    }
  }

  // Make deleteToken available globally for onclick handlers
  (window as any).deleteToken = deleteToken;

  // Initialize
  loadAdminData();
  loadAsdfPrimaryData();
  loadTableCounts();

  // Bind buttons
  document.getElementById('expand-btn')?.addEventListener('click', toggleExpanded);
  document.getElementById('test-tokens-btn')?.addEventListener('click', testAllTokens);
  document.getElementById('delete-invalid-btn')?.addEventListener('click', deleteInvalidTokens);
  document.getElementById('asdf-expand-btn')?.addEventListener('click', toggleAsdfExpanded);
  document.getElementById('table-counts-expand-btn')?.addEventListener('click', toggleTableCountsExpanded);
</script>
