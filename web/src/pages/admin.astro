---
import Layout from '../layouts/Layout.astro';
import { getAuthCookie } from '../lib/auth';
import { isAdmin } from '../lib/admin';

// Server-side admin check
const runtime = Astro.locals.runtime;
const auth = await getAuthCookie(Astro.request, runtime.env.API_SECRET);

if (!auth || !isAdmin(auth.username)) {
  return Astro.redirect('/');
}
---

<Layout title="Admin" description="Admin dashboard">
  <div class="space-y-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-100">Admin Dashboard</h1>
      <p class="text-gray-400 text-sm mt-1">Token pool management and system status</p>
    </div>

    <!-- Token Stats Overview -->
    <div id="admin-stats" class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 animate-pulse">
        <div class="h-4 bg-dark-700 rounded w-24 mb-2"></div>
        <div class="h-8 bg-dark-700 rounded w-16"></div>
      </div>
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 animate-pulse">
        <div class="h-4 bg-dark-700 rounded w-24 mb-2"></div>
        <div class="h-8 bg-dark-700 rounded w-16"></div>
      </div>
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 animate-pulse">
        <div class="h-4 bg-dark-700 rounded w-24 mb-2"></div>
        <div class="h-8 bg-dark-700 rounded w-16"></div>
      </div>
      <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 animate-pulse">
        <div class="h-4 bg-dark-700 rounded w-24 mb-2"></div>
        <div class="h-8 bg-dark-700 rounded w-16"></div>
      </div>
    </div>

    <!-- Expiring Tokens Alert -->
    <div id="expiring-alert" class="hidden bg-orange-900/20 border border-orange-500/30 rounded-lg p-4">
      <h3 class="text-orange-400 font-medium mb-2">Tokens Expiring Soon (24h)</h3>
      <div id="expiring-list" class="space-y-1"></div>
    </div>

    <!-- Token Details Table -->
    <div class="bg-dark-800 border border-dark-600 rounded-lg overflow-hidden">
      <div class="px-4 py-3 border-b border-dark-600 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-200">Token Pool</h2>
        <div class="flex items-center gap-2">
          <button
            id="delete-invalid-btn"
            class="hidden px-3 py-1.5 bg-red-900/50 hover:bg-red-900 border border-red-700 rounded-lg text-sm text-red-300 hover:text-red-100 transition-colors"
          >
            Delete Invalid Tokens
          </button>
          <button
            id="test-tokens-btn"
            class="px-3 py-1.5 bg-dark-700 hover:bg-dark-600 border border-dark-500 rounded-lg text-sm text-gray-300 hover:text-white transition-colors"
          >
            Test All Tokens
          </button>
        </div>
      </div>
      <div class="relative">
        <!-- Loading overlay -->
        <div id="table-loading-overlay" class="hidden absolute inset-0 bg-dark-900/70 z-10 flex items-center justify-center">
          <div class="flex flex-col items-center gap-2">
            <svg class="animate-spin h-8 w-8 text-neon-purple" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm text-gray-400">Testing tokens...</span>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-dark-700">
              <tr>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">User</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Usage</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Last Used</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400">Status</th>
                <th class="px-4 py-2 text-left text-sm font-medium text-gray-400 w-20"></th>
              </tr>
            </thead>
            <tbody id="token-table-body" class="divide-y divide-dark-600">
              <tr>
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Store token data globally for test results
  let tokenData: Array<{
    id: number;
    user_name: string | null;
    user_id: string | null;
    usage_count: number;
    last_used: string | null;
    is_active: number;
    rate_limited_at: string | null;
    expires_at: string | null;
  }> = [];

  // Store test results
  let testResults: Map<number, { valid: boolean; error?: string; rateLimit?: { remaining: number; limit: number } }> = new Map();

  function getInvalidTokenIds(): number[] {
    const invalidIds: number[] = [];
    testResults.forEach((result, id) => {
      if (!result.valid) {
        invalidIds.push(id);
      }
    });
    return invalidIds;
  }

  function updateDeleteInvalidButton() {
    const btn = document.getElementById('delete-invalid-btn');
    if (!btn) return;

    const invalidIds = getInvalidTokenIds();
    if (invalidIds.length > 0) {
      btn.classList.remove('hidden');
      btn.textContent = `Delete Invalid Tokens (${invalidIds.length})`;
    } else {
      btn.classList.add('hidden');
    }
  }

  function renderTokenTable() {
    const tableBody = document.getElementById('token-table-body');
    if (!tableBody) return;

    if (tokenData.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-gray-500">No tokens in pool</td>
        </tr>
      `;
      return;
    }

    // Sort by user_id (username)
    const sortedTokens = [...tokenData].sort((a, b) => {
      const aName = (a.user_id || '').toLowerCase();
      const bName = (b.user_id || '').toLowerCase();
      return aName.localeCompare(bName);
    });

    tableBody.innerHTML = sortedTokens.map((t) => {
      const isRateLimited = t.rate_limited_at && new Date(t.rate_limited_at) > new Date();
      const testResult = testResults.get(t.id);

      let statusClass = isRateLimited ? 'text-orange-400' : (t.is_active ? 'text-green-400' : 'text-red-400');
      let statusText = isRateLimited ? 'Rate Limited' : (t.is_active ? 'Active' : 'Inactive');

      // Override with test result if available
      if (testResult) {
        if (testResult.valid) {
          statusClass = 'text-green-400';
          statusText = testResult.rateLimit ? `Valid (${testResult.rateLimit.remaining}/${testResult.rateLimit.limit})` : 'Valid';
        } else {
          statusClass = 'text-red-400';
          statusText = 'Invalid';
        }
      }

      return `
        <tr class="hover:bg-dark-700/50" data-token-id="${t.id}">
          <td class="px-4 py-3">
            <div class="text-gray-200">${t.user_id || 'Unknown'}</div>
            <div class="text-xs text-gray-500">${t.user_name || ''}</div>
          </td>
          <td class="px-4 py-3 text-gray-300">${t.usage_count.toLocaleString()}</td>
          <td class="px-4 py-3 text-gray-400 text-sm">${t.last_used ? new Date(t.last_used).toLocaleString() : 'Never'}</td>
          <td class="px-4 py-3">
            <span class="${statusClass} text-sm">${statusText}</span>
          </td>
          <td class="px-4 py-3">
            <button
              onclick="deleteToken(${t.id})"
              class="text-gray-500 hover:text-red-400 transition-colors"
              title="Delete token"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function deleteToken(tokenId: number) {
    if (!confirm('Are you sure you want to delete this token?')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/tokens/${tokenId}`, { method: 'DELETE' });
      if (!response.ok) {
        throw new Error('Failed to delete token');
      }

      // Remove from local data and re-render
      tokenData = tokenData.filter(t => t.id !== tokenId);
      testResults.delete(tokenId);
      renderTokenTable();
      updateDeleteInvalidButton();

      // Reload stats
      loadAdminData();
    } catch (error) {
      console.error('Failed to delete token:', error);
      alert('Failed to delete token');
    }
  }

  async function deleteInvalidTokens() {
    const invalidIds = getInvalidTokenIds();
    if (invalidIds.length === 0) return;

    if (!confirm(`Are you sure you want to delete ${invalidIds.length} invalid token(s)?`)) {
      return;
    }

    const btn = document.getElementById('delete-invalid-btn') as HTMLButtonElement;
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Deleting...';
    }

    try {
      const response = await fetch('/api/admin/tokens/delete-batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: invalidIds }),
      });

      if (!response.ok) {
        throw new Error('Failed to delete tokens');
      }

      // Remove from local data and re-render
      tokenData = tokenData.filter(t => !invalidIds.includes(t.id));
      invalidIds.forEach(id => testResults.delete(id));
      renderTokenTable();
      updateDeleteInvalidButton();

      // Reload stats
      loadAdminData();
    } catch (error) {
      console.error('Failed to delete invalid tokens:', error);
      alert('Failed to delete invalid tokens');
    } finally {
      if (btn) {
        btn.disabled = false;
        updateDeleteInvalidButton();
      }
    }
  }

  async function loadAdminData() {
    try {
      const response = await fetch('/api/admin/tokens');
      if (!response.ok) {
        throw new Error('Failed to load admin data');
      }
      const data = await response.json();
      tokenData = data.tokens;

      // Count rate-limited tokens
      const rateLimitedCount = data.tokens.filter((t: { rate_limited_at: string | null }) => {
        if (!t.rate_limited_at) return false;
        return new Date(t.rate_limited_at) > new Date();
      }).length;

      // Update stats cards
      const statsContainer = document.getElementById('admin-stats');
      if (statsContainer) {
        statsContainer.innerHTML = `
          <div class="bg-dark-800 border border-dark-600 rounded-lg p-6">
            <div class="text-sm text-gray-400 mb-1">Active Tokens</div>
            <div class="text-3xl font-bold text-green-400">${data.stats.active}</div>
          </div>
          <div class="bg-dark-800 border border-dark-600 rounded-lg p-6">
            <div class="text-sm text-gray-400 mb-1">Total Tokens</div>
            <div class="text-3xl font-bold text-gray-100">${data.stats.total}</div>
          </div>
          <div class="bg-dark-800 border border-dark-600 rounded-lg p-6">
            <div class="text-sm text-gray-400 mb-1">Rate Limited</div>
            <div class="text-3xl font-bold text-orange-400">${rateLimitedCount}</div>
          </div>
          <div class="bg-dark-800 border border-dark-600 rounded-lg p-6">
            <div class="text-sm text-gray-400 mb-1">Expiring Soon</div>
            <div class="text-3xl font-bold ${data.expiringSoon.length > 0 ? 'text-orange-400' : 'text-gray-100'}">${data.expiringSoon.length}</div>
          </div>
        `;
      }

      // Show expiring tokens alert if any
      const alertContainer = document.getElementById('expiring-alert');
      const expiringList = document.getElementById('expiring-list');
      if (alertContainer && expiringList && data.expiringSoon.length > 0) {
        alertContainer.classList.remove('hidden');
        expiringList.innerHTML = data.expiringSoon.map((t: { user_name: string | null; expires_at: string }) => `
          <div class="text-sm text-orange-300">${t.user_name || 'Unknown'} - expires ${new Date(t.expires_at).toLocaleString()}</div>
        `).join('');
      }

      // Render token table
      renderTokenTable();
    } catch (error) {
      console.error('Failed to load admin data:', error);
      const tableBody = document.getElementById('token-table-body');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-red-400">Failed to load data</td>
          </tr>
        `;
      }
    }
  }

  async function testAllTokens() {
    const btn = document.getElementById('test-tokens-btn') as HTMLButtonElement;
    const overlay = document.getElementById('table-loading-overlay');
    if (!btn) return;

    btn.disabled = true;
    btn.textContent = 'Testing...';
    overlay?.classList.remove('hidden');

    try {
      const response = await fetch('/api/admin/tokens/test', { method: 'POST' });
      if (!response.ok) {
        throw new Error('Failed to test tokens');
      }
      const data = await response.json();

      // Store results
      testResults.clear();
      for (const result of data.results) {
        testResults.set(result.id, {
          valid: result.valid,
          error: result.error,
          rateLimit: result.rateLimit,
        });
      }

      // Re-render table with results
      renderTokenTable();
      updateDeleteInvalidButton();

      btn.textContent = `Tested: ${data.summary.valid}/${data.summary.total} valid`;
      setTimeout(() => {
        btn.textContent = 'Test All Tokens';
      }, 3000);
    } catch (error) {
      console.error('Failed to test tokens:', error);
      btn.textContent = 'Test Failed';
      setTimeout(() => {
        btn.textContent = 'Test All Tokens';
      }, 3000);
    } finally {
      btn.disabled = false;
      overlay?.classList.add('hidden');
    }
  }

  // Make deleteToken available globally for onclick handlers
  (window as any).deleteToken = deleteToken;

  // Initialize
  loadAdminData();

  // Bind buttons
  document.getElementById('test-tokens-btn')?.addEventListener('click', testAllTokens);
  document.getElementById('delete-invalid-btn')?.addEventListener('click', deleteInvalidTokens);
</script>
