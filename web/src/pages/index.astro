---
import Layout from '../layouts/Layout.astro';
import { ToolSearch } from '../components/ToolSearch';
import { drizzle } from 'drizzle-orm/d1';
import { setupAnalytics } from '../../../src/analytics';
import { loadToolsJson, type ToolsData } from '../lib/data-loader';

const runtime = Astro.locals.runtime;

// Load tools.json from R2 bucket
let toolsData: ToolsData = { tool_count: 0, tools: [] };
try {
  const bucket = runtime.env.DATA_BUCKET;
  const data = await loadToolsJson(bucket);
  if (data) {
    toolsData = data;
  }
} catch (e) {
  console.error('Failed to load tools.json from R2:', e);
}

// Fetch downloads and trending data
let downloads: Record<string, number> = {};
let trendingTools: Array<{
  name: string;
  downloads_30d: number;
  trendingScore: number;
  dailyBoost: number;
  sparkline: number[];
}> = [];
try {
  const db = drizzle(runtime.env.ANALYTICS_DB);
  const analytics = setupAnalytics(db);
  downloads = await analytics.getAll30DayDownloads();
  trendingTools = await analytics.getTrendingTools(6);
} catch (e) {
  console.error('Failed to fetch downloads:', e);
}
---

<Layout title="mise versions" description="Browse tool versions and download stats for mise">
  <ToolSearch client:load tools={toolsData.tools} downloads={downloads} trendingTools={trendingTools} />
</Layout>
