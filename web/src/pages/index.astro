---
import Layout from '../layouts/Layout.astro';
import { ToolSearch } from '../components/ToolSearch';
import { drizzle } from 'drizzle-orm/d1';
import { setupAnalytics } from '../../../src/analytics';
import { loadToolsJson, type ToolsData } from '../lib/data-loader';

const runtime = Astro.locals.runtime;

// Load tools.json from R2 bucket
let toolsData: ToolsData = { tool_count: 0, tools: [] };
try {
  const bucket = runtime.env.DATA_BUCKET;
  const data = await loadToolsJson(bucket);
  if (data) {
    toolsData = data;
  }
} catch (e) {
  console.error('Failed to load tools.json from R2:', e);
}

// Fetch downloads data
let downloads: Record<string, number> = {};
try {
  const db = drizzle(runtime.env.ANALYTICS_DB);
  const analytics = setupAnalytics(db);
  downloads = await analytics.getAll30DayDownloads();
} catch (e) {
  console.error('Failed to fetch downloads:', e);
}
---

<Layout title="mise tools" description="Browse tool versions and download stats for mise">
  <div class="mb-4">
    <h1 class="text-2xl font-bold text-gray-100 mb-2">mise tools</h1>
  </div>

  <ToolSearch client:load tools={toolsData.tools} downloads={downloads} />
</Layout>
