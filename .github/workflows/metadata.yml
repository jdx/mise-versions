name: metadata
on:
  workflow_dispatch:
  schedule:
    # Run every Sunday at 3:47 AM UTC
    - cron: "47 3 * * 0"

concurrency:
  group: metadata
  cancel-in-progress: true

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.MISE_GITHUB_TOKEN }}
  TOKEN_MANAGER_URL: https://mise-tools.jdx.dev
  TOKEN_MANAGER_SECRET: ${{ secrets.TOKEN_MANAGER_SECRET }}

jobs:
  fetch-metadata:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm install

      - name: Fetch tool metadata
        run: node scripts/fetch-metadata.js

      - name: Regenerate manifest with metadata
        run: |
          # Install mise for the generate-manifest.js script
          curl https://mise.jdx.dev/install.sh | sh
          export PATH="$HOME/.local/bin:$PATH"
          node scripts/generate-manifest.js

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Discard any unstaged changes we don't want to commit
          git checkout -- . || true
          git add docs/metadata-cache.json docs/tools.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update tool metadata cache"
            # Pull with rebase to handle concurrent updates from update.sh
            git pull --rebase origin main
            git push
          fi
